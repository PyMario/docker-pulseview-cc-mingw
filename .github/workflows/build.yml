jobs:
  build_docker_image:
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”¨ Attempt to Build MXE Stage (Stage 1)
      id: mxe_build_attempt
      # å°è¯•æ„å»ºåˆ° stage1ï¼Œå¹¶ç»™é•œåƒæ‰“æ ‡ç­¾ã€‚
      # ä½¿ç”¨ '|| true' ç¡®ä¿å³ä½¿æ„å»ºå¤±è´¥ï¼ŒJob ä¹Ÿä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚
      run: |
        echo "Attempting to build Docker stage1..."
        docker build -t pulseview-stage1:fail-log --target stage1 . || true

    - name: ğŸ“ Extract Failed 'check' Build Log
      id: extract_log
      # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸï¼Œå¦‚æœä¸æˆåŠŸï¼Œåˆ™ä»å¤±è´¥çš„é•œåƒä¸­æå–æ—¥å¿—
      run: |
        LOG_FILE="check_failure.log"
        LOG_PATH="/root/mxe-git/log/check_x86_64-w64-mingw32.static.posix"
        ARTIFACT_DIR="extracted_logs"
        
        # 1. å°è¯•åˆ›å»ºå¹¶å¯åŠ¨ä¸´æ—¶å®¹å™¨ï¼ˆä½¿ç”¨ä¸Šä¸€æ­¥çš„å¤±è´¥é•œåƒï¼‰
        CONTAINER_ID=$(docker create pulseview-stage1:fail-log)
        if [ "$CONTAINER_ID" == "" ]; then
          echo "::warning::Could not create temporary container. Skipping log extraction."
          exit 0
        fi
        
        # 2. ä»å®¹å™¨ä¸­å¤åˆ¶æ—¥å¿—æ–‡ä»¶
        mkdir -p $ARTIFACT_DIR
        if docker cp $CONTAINER_ID:$LOG_PATH $ARTIFACT_DIR/$LOG_FILE; then
          echo "Log file copied successfully to $ARTIFACT_DIR/$LOG_FILE"
          echo "LOG_EXTRACTED=true" >> $GITHUB_OUTPUT
        else
          echo "Log file $LOG_PATH was not found in the container. Build might have succeeded or failed elsewhere."
        fi
        
        # 3. æ¸…ç†ä¸´æ—¶å®¹å™¨
        docker rm $CONTAINER_ID

    - name: â¬†ï¸ Upload Failure Log Artifact
      uses: actions/upload-artifact@v4
      with:
        name: check-build-failure-log
        # ç¡®ä¿åªåœ¨æ—¥å¿—æ–‡ä»¶å­˜åœ¨æ—¶æ‰ä¸Šä¼ 
        path: extracted_logs/check_failure.log
        if-no-files-found: ignore

    - name: ğŸ›‘ Fail Job if Log Was Extracted
      # åªæœ‰å½“ LOG_EXTRACTED ä¸º true æ—¶æ‰è¿è¡Œæ­¤æ­¥éª¤ï¼Œç¡®ä¿ Job çŠ¶æ€ä¸ºå¤±è´¥
      if: steps.extract_log.outputs.LOG_EXTRACTED == 'true'
      run: |
        echo "::error title=MXE Compilation Failed::The 'check' package failed to compile. See the uploaded 'check-build-failure-log' artifact for details."
        exit 1
