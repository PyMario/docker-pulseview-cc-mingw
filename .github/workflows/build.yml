name: Cross-Compile PulseView for Windows (MinGW)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  build_docker_image:
    runs-on: ubuntu-latest
    
    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      
    # æ­¥éª¤ 1: æ„å»º Docker é•œåƒ
    - name: ğŸ”¨ Build Docker Image
      id: docker_build
      uses: docker/build-push-action@v5
      with:
        context: .
        # æ„å»ºæ—¶ä½¿ç”¨ç‰¹å®šçš„æ ‡ç­¾ï¼Œä¾‹å¦‚ 'pulseview-cc'
        tags: pulseview-cc-mingw:latest
        load: true # æ„å»ºåå°†é•œåƒåŠ è½½åˆ°è¿è¡Œå™¨ç¯å¢ƒä¸­
        
    # æ­¥éª¤ 2: è¿è¡Œå®¹å™¨ä»¥è§¦å‘æœ€ç»ˆçš„æ„å»ºè„šæœ¬
    # å‡è®¾ 'docker-pulseview-cc-mingw' é•œåƒåœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨è¿è¡Œ cc-mingw.sh å¹¶ç”Ÿæˆæ–‡ä»¶
    # è­¦å‘Šï¼šæ‚¨éœ€è¦ç¡®è®¤è¯¥ Dockerfile å’Œå…¥å£ç‚¹æ˜¯å¦ä¼šè‡ªåŠ¨å¯åŠ¨æ„å»ºè¿‡ç¨‹ã€‚
    - name: âš™ï¸ Run Container to Generate Artifacts
      id: container_run
      run: |
        # è¿è¡Œå®¹å™¨ï¼Œå¹¶å°†è¾“å‡ºç›®å½•æŒ‚è½½åˆ°å·¥ä½œç›®å½•ï¼Œä»¥ä¾¿æå–æ–‡ä»¶
        # æ³¨æ„: è¿™éƒ¨åˆ†ä¾èµ–äºåŸé¡¹ç›®çš„ Dockerfile å’Œ cc-mingw.sh å¦‚ä½•è®¾ç½®è¾“å‡º
        # æˆ‘ä»¬å‡è®¾è¾“å‡ºæ–‡ä»¶ä½äºå®¹å™¨å†…çš„ /cc-mingw/ ç›®å½•
        mkdir -p output_artifacts
        
        # è¿è¡Œå®¹å™¨ï¼Œå¹¶å°† /cc-mingw/output æŒ‚è½½åˆ° host çš„ output_artifacts
        # å¦‚æœåŸå§‹é¡¹ç›®çš„è„šæœ¬åœ¨æ„å»ºæ—¶ç›´æ¥ç”Ÿæˆæ–‡ä»¶åˆ°ç‰¹å®šç›®å½•ï¼Œè¿™å¯èƒ½éœ€è¦è°ƒæ•´
        docker run -v $(pwd)/output_artifacts:/cc-mingw/output pulseview-cc-mingw:latest
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        ls -l output_artifacts/
        
    # æ­¥éª¤ 3: ä¸Šä¼ ç”Ÿæˆçš„ Windows å®‰è£…ç¨‹åºä½œä¸º Artifact
    - name: â¬†ï¸ Upload Windows Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: pulseview-windows-installer
        # å‡è®¾ç”Ÿæˆçš„å®‰è£…ç¨‹åºä½äº output_artifacts ç›®å½•ä¸‹
        path: output_artifacts/*.exe
        # å¦‚æœæ˜¯å¤šä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æ›´å…·ä½“çš„é€šé…ç¬¦
